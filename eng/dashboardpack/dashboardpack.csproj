<Project>
  <Import Sdk="Microsoft.NET.Sdk" Project="Sdk.props" />

  <Import Project="$(SharedDir)Workload.targets" />

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <IsPackable>true</IsPackable>
    <SuppressDependenciesWhenPacking>true</SuppressDependenciesWhenPacking>
    <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <PackageOutputPath Condition=" '$(PackageOutputPath)' == '' ">$(ArtifactsShippingPackagesDir)</PackageOutputPath>
  </PropertyGroup>

  <PropertyGroup>
    <PackageId>Aspire.Dashboard.Sdk.$(DashboardRuntime)</PackageId>
    <Description>Dashboard browser interface for .NET Aspire.</Description>
  </PropertyGroup>

  <PropertyGroup>
    <DashboardPlatformType Condition=" '$(DashboardPlatformType)' == '' and $(DcpPlatform.StartsWith('win-')) ">Windows</DashboardPlatformType>
    <DashboardPlatformType Condition=" '$(DashboardPlatformType)' == '' ">Unix</DashboardPlatformType>
    <DashboardPublishDir>$(DotNetOutputPath)Aspire.Dashboard/$(DashboardRuntime)/$(Configuration)/$(TargetFramework)/$(DashboardRuntime)/publish/</DashboardPublishDir>
  </PropertyGroup>

  <Import Sdk="Microsoft.NET.Sdk" Project="Sdk.targets" />

  <Target Name="Build" />

  <!-- For MacOS, we need to update the publish output with final signed binaries -->
  <Target Name="UpdateSignedFiles" Condition="Exists('$(ArtifactsTmpDir)MacSigning/Aspire.Dashboard.$(RuntimeIdentifier).zip') and '$(Sign)' == 'true'">
    <Unzip SourceFiles="$(ArtifactsTmpDir)MacSigning/Aspire.Dashboard.$(RuntimeIdentifier).zip"
           DestinationFolder="$(DashboardPublishDir)" />
    <Delete Files="$(ArtifactsTmpDir)MacSigning/Aspire.Dashboard.$(RuntimeIdentifier).zip" />
  </Target>

  <!-- The dashboard should have been published for all appropriate RIDs during the normal build -->
  <Target Name="BeforeBuild" BeforeTargets="Build" DependsOnTargets="UpdateSignedFiles">
    <ItemGroup>
      <_PublishItems Include="$(DashboardPublishDir)**/*" />
      <None Include="@(_PublishItems)" Pack="true" PackagePath="tools/" />
    </ItemGroup>

    <!-- Throw an error if _PublishItems is empty. -->
    <Error Condition="'@(_PublishItems)' == ''" Text="No files were found to pack. Ensure that the project being packed has a publish target defined." />
  </Target>

  <ItemGroup>
    <None Include="Sdk.props" Pack="true" PackagePath="Sdk/" />
    <None Include="Sdk.targets" Pack="true" PackagePath="Sdk/" />
    <None Include="UnixFilePermissions.xml" Pack="true" PackagePath="data/" Condition=" '$(DashboardPlatformType)' == 'Unix' " />
  </ItemGroup>

</Project>